<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Reset Password - ZUZZ TV</title>
<link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#ff5722">
<style>
:root{--p:#ff5722;--bg:#0d1117;--card:#161b22;--bdr:#30363d;--txt:#f0f6fc;--mut:#8b949e;--ok:#3fb950}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--bg);color:var(--txt);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.box{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:40px;width:100%;max-width:420px}
.logo{text-align:center;margin-bottom:30px}
.logo h1{font-size:32px;background:linear-gradient(135deg,#ff5722,#ff9800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo span{color:var(--mut);font-size:13px}
.fg{margin-bottom:20px}
.fg label{display:block;margin-bottom:6px;color:var(--mut);font-size:13px}
.fg input{width:100%;padding:12px;background:var(--bg);border:1px solid var(--bdr);border-radius:8px;color:var(--txt);font-size:14px}
.fg input:focus{outline:none;border-color:var(--p)}
.btn{width:100%;padding:14px;background:linear-gradient(135deg,#ff5722,#ff9800);border:none;border-radius:8px;color:#fff;font-size:15px;font-weight:600;cursor:pointer}
.btn:hover{opacity:.9}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:var(--bg);border:1px solid var(--bdr);color:var(--txt)}
.btn-secondary:hover{background:var(--bdr)}
.msg{padding:12px;border-radius:6px;margin-bottom:15px;font-size:13px;display:none}
.msg.show{display:block}
.msg.err{background:rgba(248,81,73,.1);border:1px solid #f85149;color:#f85149}
.msg.ok{background:rgba(63,185,80,.1);border:1px solid var(--ok);color:var(--ok)}
.links{text-align:center;margin-top:20px;font-size:13px}
.links a{color:var(--p);text-decoration:none}

/* Steps */
.step{display:none}
.step.active{display:block}

/* Code input */
.code-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0}
.code-inputs input{width:50px;height:55px;text-align:center;font-size:24px;font-weight:700;background:var(--bg);border:2px solid var(--bdr);border-radius:10px;color:var(--txt)}
.code-inputs input:focus{outline:none;border-color:var(--p)}

/* Timer */
.timer{text-align:center;color:var(--mut);font-size:13px;margin-top:15px}
.timer span{color:var(--p);font-weight:600}

/* Password strength */
.strength{height:4px;background:var(--bdr);border-radius:2px;margin-top:8px;overflow:hidden}
.strength-bar{height:100%;transition:all .3s}
.strength-bar.weak{width:33%;background:#f85149}
.strength-bar.medium{width:66%;background:#ff9800}
.strength-bar.strong{width:100%;background:var(--ok)}

.pass-match{font-size:12px;margin-top:5px}
.pass-match.ok{color:var(--ok)}
.pass-match.err{color:#f85149}
</style>
</head>
<body>
<div class="box">
<div class="logo"><h1 id="site-logo">ZUZZ TV</h1><span>Reset your password</span></div>
<div class="msg" id="msg"></div>

<!-- Step 1: Enter Email -->
<div class="step active" id="step1">
    <p style="color:var(--mut);font-size:14px;margin-bottom:20px;text-align:center">
        Enter your email address and we'll send you a verification code.
    </p>
    <div class="fg">
        <label>üìß Email Address</label>
        <input type="email" id="email-input" autofocus placeholder="your@email.com">
    </div>
    <button class="btn" id="send-btn" onclick="sendCode()">üì§ Send Verification Code</button>
</div>

<!-- Step 2: Enter Code -->
<div class="step" id="step2">
    <p style="color:var(--mut);font-size:14px;margin-bottom:10px;text-align:center">
        We sent a 6-digit code to<br><strong id="sent-email" style="color:var(--p)"></strong>
    </p>
    <div class="code-inputs">
        <input type="text" maxlength="1" id="c1" oninput="codeInput(this,1)" onkeydown="codeKey(event,1)">
        <input type="text" maxlength="1" id="c2" oninput="codeInput(this,2)" onkeydown="codeKey(event,2)">
        <input type="text" maxlength="1" id="c3" oninput="codeInput(this,3)" onkeydown="codeKey(event,3)">
        <input type="text" maxlength="1" id="c4" oninput="codeInput(this,4)" onkeydown="codeKey(event,4)">
        <input type="text" maxlength="1" id="c5" oninput="codeInput(this,5)" onkeydown="codeKey(event,5)">
        <input type="text" maxlength="1" id="c6" oninput="codeInput(this,6)" onkeydown="codeKey(event,6)">
    </div>
    <button class="btn" id="verify-btn" onclick="verifyCode()">‚úì Verify Code</button>
    <div class="timer" id="timer">
        Resend code in <span id="countdown">60</span>s
    </div>
    <button class="btn btn-secondary" id="resend-btn" onclick="sendCode()" style="margin-top:10px;display:none">üîÑ Resend Code</button>
</div>

<!-- Step 3: New Password -->
<div class="step" id="step3">
    <p style="color:var(--mut);font-size:14px;margin-bottom:20px;text-align:center">
        ‚úÖ Code verified! Now create your new password.
    </p>
    <div class="fg">
        <label>üîê New Password</label>
        <input type="password" id="pass1" placeholder="Min 6 characters" oninput="checkPassword()">
        <div class="strength"><div class="strength-bar" id="strength-bar"></div></div>
    </div>
    <div class="fg">
        <label>üîê Confirm Password</label>
        <input type="password" id="pass2" placeholder="Re-enter password" oninput="checkPassword()">
        <div class="pass-match" id="pass-match"></div>
    </div>
    <button class="btn" id="reset-btn" onclick="resetPassword()" disabled>üíæ Save New Password</button>
</div>

<!-- Step 4: Success -->
<div class="step" id="step4">
    <div style="text-align:center">
        <div style="font-size:60px;margin-bottom:20px">‚úÖ</div>
        <h2 style="color:var(--ok);margin-bottom:10px">Password Reset!</h2>
        <p style="color:var(--mut);margin-bottom:30px">Your password has been changed successfully.</p>
        <a href="/login" class="btn" style="display:inline-block;text-decoration:none;padding:14px 40px">üîì Go to Login</a>
    </div>
</div>

<div class="links" id="back-link">
    <a href="/login">‚Üê Back to Login</a>
</div>
</div>

<script>
let userEmail = '';
let resetToken = '';
let countdownInterval = null;

// Load site name
fetch('/api/data').then(r=>r.json()).then(d=>{
    const siteName = d.settings?.site_name || 'ZUZZ TV';
    document.getElementById('site-logo').textContent = siteName;
    document.title = 'Reset Password - ' + siteName;
}).catch(()=>{});

// Enter key support
document.getElementById('email-input').addEventListener('keypress', e => {
    if(e.key === 'Enter') sendCode();
});

// Code input auto-focus
function codeInput(el, num) {
    el.value = el.value.replace(/[^0-9]/g, '');
    if(el.value && num < 6) {
        document.getElementById('c' + (num + 1)).focus();
    }
    // Auto verify when all filled
    if(num === 6 && el.value) {
        const code = getCode();
        if(code.length === 6) verifyCode();
    }
}

function codeKey(e, num) {
    if(e.key === 'Backspace' && !e.target.value && num > 1) {
        document.getElementById('c' + (num - 1)).focus();
    }
}

function getCode() {
    return [1,2,3,4,5,6].map(i => document.getElementById('c'+i).value).join('');
}

function showMsg(text, type) {
    const msg = document.getElementById('msg');
    msg.textContent = text;
    msg.className = 'msg show ' + type;
}

function hideMsg() {
    document.getElementById('msg').className = 'msg';
}

function goToStep(num) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + num).classList.add('active');
    if(num === 4) document.getElementById('back-link').style.display = 'none';
}

function startCountdown() {
    let seconds = 60;
    document.getElementById('timer').style.display = 'block';
    document.getElementById('resend-btn').style.display = 'none';
    document.getElementById('countdown').textContent = seconds;
    
    countdownInterval = setInterval(() => {
        seconds--;
        document.getElementById('countdown').textContent = seconds;
        if(seconds <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('timer').style.display = 'none';
            document.getElementById('resend-btn').style.display = 'block';
        }
    }, 1000);
}

async function sendCode() {
    const email = document.getElementById('email-input').value.trim().toLowerCase();
    const btn = document.getElementById('send-btn');
    
    hideMsg();
    
    if(!email || !email.includes('@')) {
        showMsg('Please enter a valid email address', 'err');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Sending...';
    
    try {
        const r = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email})
        });
        const d = await r.json();
        
        if(d.success) {
            userEmail = email;
            document.getElementById('sent-email').textContent = email;
            goToStep(2);
            document.getElementById('c1').focus();
            startCountdown();
            // Clear old code inputs
            [1,2,3,4,5,6].forEach(i => document.getElementById('c'+i).value = '');
        } else {
            showMsg(d.error || 'Email not found', 'err');
        }
    } catch(e) {
        showMsg('Connection error. Please try again.', 'err');
    }
    
    btn.disabled = false;
    btn.textContent = 'üì§ Send Verification Code';
}

async function verifyCode() {
    const code = getCode();
    const btn = document.getElementById('verify-btn');
    
    hideMsg();
    
    if(code.length !== 6) {
        showMsg('Please enter the 6-digit code', 'err');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Verifying...';
    
    try {
        const r = await fetch('/api/verify-reset-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: userEmail, code})
        });
        const d = await r.json();
        
        if(d.success) {
            resetToken = d.token;
            goToStep(3);
            document.getElementById('pass1').focus();
            if(countdownInterval) clearInterval(countdownInterval);
        } else {
            showMsg(d.error || 'Invalid code', 'err');
        }
    } catch(e) {
        showMsg('Connection error. Please try again.', 'err');
    }
    
    btn.disabled = false;
    btn.textContent = '‚úì Verify Code';
}

function checkPassword() {
    const pass1 = document.getElementById('pass1').value;
    const pass2 = document.getElementById('pass2').value;
    const bar = document.getElementById('strength-bar');
    const match = document.getElementById('pass-match');
    const btn = document.getElementById('reset-btn');
    
    // Strength check
    bar.className = 'strength-bar';
    if(pass1.length >= 6) {
        if(pass1.length >= 10 && /[A-Z]/.test(pass1) && /[0-9]/.test(pass1)) {
            bar.classList.add('strong');
        } else if(pass1.length >= 8) {
            bar.classList.add('medium');
        } else {
            bar.classList.add('weak');
        }
    }
    
    // Match check
    if(pass2) {
        if(pass1 === pass2) {
            match.textContent = '‚úì Passwords match';
            match.className = 'pass-match ok';
        } else {
            match.textContent = '‚úó Passwords do not match';
            match.className = 'pass-match err';
        }
    } else {
        match.textContent = '';
    }
    
    // Enable button
    btn.disabled = !(pass1.length >= 6 && pass1 === pass2);
}

async function resetPassword() {
    const pass1 = document.getElementById('pass1').value;
    const pass2 = document.getElementById('pass2').value;
    const btn = document.getElementById('reset-btn');
    
    hideMsg();
    
    if(pass1.length < 6) {
        showMsg('Password must be at least 6 characters', 'err');
        return;
    }
    
    if(pass1 !== pass2) {
        showMsg('Passwords do not match', 'err');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ Saving...';
    
    try {
        const r = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: userEmail,
                token: resetToken,
                password: pass1
            })
        });
        const d = await r.json();
        
        if(d.success) {
            goToStep(4);
        } else {
            showMsg(d.error || 'Failed to reset password', 'err');
            btn.disabled = false;
            btn.textContent = 'üíæ Save New Password';
        }
    } catch(e) {
        showMsg('Connection error. Please try again.', 'err');
        btn.disabled = false;
        btn.textContent = 'üíæ Save New Password';
    }
}
</script>
</body>
</html>
